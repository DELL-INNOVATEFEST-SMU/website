# Save Journal Edge Function

This Supabase Edge Function handles saving journal entries for authenticated users only. Anonymous users are rejected with an appropriate message.

## Features

- **Authentication Required**: Only authenticated (non-anonymous) users can save journal entries
- **Anonymous User Rejection**: Returns clear message that journal saving is not available for anonymous users
- **Comprehensive Validation**: Validates all input fields including title, content, mood, and tags
- **Error Handling**: Robust error handling with user-friendly messages
- **CORS Support**: Full CORS support for web applications

## API Endpoint

```
POST /functions/v1/save-journal
```

## Request Headers

```
Authorization: Bearer <supabase_jwt_token>
Content-Type: application/json
```

## Request Body

```typescript
{
  journal_entry: string                    // Required: The journal entry text content
  thinking_traps?: Record<string, any>     // Optional: JSON object containing thinking trap data
}
```

## Response

### Success Response (201)

```typescript
{
  success: true,
  entry: {
    id: number,
    created_at: string,
    journal_entry: string,
    user_id: string,
    thinking_traps?: Record<string, any>
  }
}
```

### Error Responses

#### Anonymous User (403)

```typescript
{
  success: false,
  error: "Journal saving is not available for anonymous users. Please create an account to save your journal entries."
}
```

#### Authentication Required (401)

```typescript
{
  success: false,
  error: "Authentication required. Please sign in to save journal entries."
}
```

#### Validation Error (400)

```typescript
{
  success: false,
  error: "Validation error message"
}
```

#### Server Error (500)

```typescript
{
  success: false,
  error: "Server error message"
}
```

## Database Schema

The function works with the `public.journals` table with the following schema:

```sql
CREATE TABLE public.journals (
  id bigint generated by default as identity not null,
  created_at date not null,
  journal_entry text null,
  user_id uuid not null,
  thinking_traps jsonb null,
  constraint journals_pkey primary key (created_at, user_id)
) TABLESPACE pg_default;

-- Add RLS policies
ALTER TABLE public.journals ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own entries" ON public.journals
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own entries" ON public.journals
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own entries" ON public.journals
  FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own entries" ON public.journals
  FOR DELETE USING (auth.uid() = user_id);
```

**Note:** The table uses a composite primary key of `(created_at, user_id)`, meaning each user can have only one journal entry per day.

## Usage Example

```typescript
const response = await fetch("/functions/v1/save-journal", {
  method: "POST",
  headers: {
    Authorization: `Bearer ${session.access_token}`,
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    journal_entry:
      "Today I explored the solar system and learned about Mars. It was fascinating to discover the red planet's unique characteristics and think about the possibility of future human exploration.",
    thinking_traps: {
      catastrophizing: false,
      all_or_nothing: true,
      overgeneralization: false,
    },
  }),
});

const result = await response.json();

if (result.success) {
  console.log("Journal entry saved:", result.entry);
} else {
  console.error("Failed to save journal:", result.error);
}
```

## Environment Variables

The function requires the following environment variables:

- `SUPABASE_URL`: Your Supabase project URL
- `SUPABASE_SERVICE_ROLE_KEY`: Your Supabase service role key (for database operations)

## Deployment

Deploy the function using the Supabase CLI:

```bash
supabase functions deploy save-journal
```
