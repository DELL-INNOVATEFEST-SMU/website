<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cosmic Compass</title>
  <style>
    /* Space theme + unified CTA styles (full file) */
    :root{--bg1:#0b1020;--bg2:#06060b;--ink:#eef1ff;--muted:#aab0ff;--accent:#7c8cfb;--card:#141a33;--card2:#10142a;--border:#263064}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink);
      background:radial-gradient(1200px 600px at 80% -10%,#2b3572,transparent),
                 radial-gradient(800px 600px at -10% 110%,#7c2f7a,transparent),
                 linear-gradient(180deg,var(--bg1),var(--bg2));
      min-height:100vh;
    }
    .container{max-width:720px;margin:0 auto;padding:20px}
    header{text-align:center;margin:12px 0 16px}
    h1{font-size:22px;margin:0;font-weight:800;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted);opacity:.9;margin-top:6px}
    .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .progress{height:8px;background:#0d1230;border-radius:999px;overflow:hidden}
    .bar{height:8px;background:linear-gradient(90deg,var(--accent),#b6bfff);transition:width .25s ease}
    .kicker{font-size:11px;color:#bfc6ff;text-transform:uppercase;letter-spacing:.14em}
    .q{font-size:17px;font-weight:700;margin:6px 0 10px}
    .opts{display:grid;gap:10px;margin-top:10px}
    .btn{width:100%;text-align:left;background:#151a3a;border:1px solid #2a356b;color:var(--ink);padding:12px 14px;border-radius:12px;cursor:pointer;font-size:14px}
    .btn:hover{background:#1c2350}
    .btn.selected{background:#3a49b3;border-color:#8aa0ff;color:#000}
    .nav{display:flex;gap:10px;margin-top:14px}
    .nav button{flex:1;padding:10px 12px;border-radius:12px;border:1px solid #2a356b;background:#151a3a;color:var(--ink);cursor:pointer}
    .nav button.primary{background:linear-gradient(90deg,var(--accent),#a2adff);color:#000;border:none}
    .hint{color:#ffb4c4;font-size:12px;margin-top:8px;display:none}
    .pill{display:inline-block;background:#0f1538;border:1px solid #2a356b;padding:6px 10px;border-radius:999px;font-size:12px;color:#c7ceff}
    footer{text-align:center;color:#98a3ff70;font-size:10px;margin:16px 0}
    .row{display:grid;gap:10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    input, select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a356b;background:#0f1538;color:var(--ink)}
    .badge{display:inline-block;padding:6px 8px;border-radius:10px;background:#0f1538;border:1px solid #2a356b;font-size:11px}
    .cta{display:inline-block;margin-top:12px;padding:10px 12px;border-radius:12px;background:linear-gradient(90deg,#f06cf0,#8c9bff);color:#000;border:none;cursor:pointer;text-decoration:none;text-align:center;font-size:14px}
    .cta.alt{background:linear-gradient(90deg,#8c9bff,#f06cf0)}
    .stars{position:fixed;inset:0;pointer-events:none}
    .stars b{position:absolute;width:2px;height:2px;background:#fff;border-radius:50%;opacity:.75}
    /* Submit gating */
    #submitBtn:disabled{opacity:.5;cursor:not-allowed}
  </style>
</head>
<body>
  <!-- Starfield -->
  <div class="stars" aria-hidden="true">
    <b style="top:8%;left:8%"></b><b style="top:20%;left:70%"></b><b style="top:60%;left:20%"></b><b style="top:80%;left:85%"></b><b style="top:35%;left:40%"></b>
  </div>

  <div class="container">
    <header>
      <h1>✦ Cosmic Compass ✦</h1>
      <div class="sub">Ready for your cosmic journey? Take this quiz to see if you're all systems go, including your mental health.</div>
    </header>

    <!-- Quiz card -->
    <div class="card" id="app">
      <div class="progress"><div class="bar" id="bar" style="width:0%"></div></div>
      <div style="margin-top:10px;text-align:right"><span class="pill" id="counter">1 / 14</span></div>

      <div class="kicker" id="kicker">Mission</div>
      <div class="q" id="qtext">Loading…</div>
      <div class="opts" id="opts"></div>
      <div class="hint" id="hint">Please pick an option to continue on your cosmic journey!</div>
      <div class="nav">
        <button id="backBtn">Back</button>
        <button class="primary" id="nextBtn">Next</button>
      </div>
    </div>

    <!-- Results card -->
    <div class="card" id="results" style="display:none;margin-top:12px">
      <h2 style="margin:0 0 6px">Unlock your planet</h2>
      <div class="sub" style="margin-bottom:10px">Enter your email or phone number to reveal your result. By doing this, you agree that you may be contacted by the Singapore Association for Mental Health.</div>
      <div class="row">
        <input id="email" type="email" placeholder="Email" />
        <input id="phone" type="tel" placeholder="Phone" />
      </div>
      <button class="cta" id="submitBtn" disabled>Submit & reveal</button>
      <div id="submitMsg" style="font-size:12px;color:#ffb4c4;margin-top:6px;display:none"></div>

      <div id="reveal" style="display:none;margin-top:12px">
        <div class="grid2">
          <div class="badge">Dominant vibe: <b id="domFlavor"></b></div>
          <div class="badge">PHQ-4 band: <b id="band"></b></div>
        </div>
        <h3 id="planetTitle" style="margin:12px 0 6px"></h3>
        <div id="planetBlurb" style="font-size:14px;color:#dfe3ff"></div>
        <a class="cta" id="eligCta" href="#" target="_blank" rel="noopener">Proceed</a>
        <button class="cta alt" id="shareBtn">Share your planet</button>
        <div style="font-size:11px;color:#aab0ff;margin-top:8px">PHQ-4 total: <b id="phqTotal"></b>. Brief screener, not a diagnosis.</div>
      </div>
    </div>

<!--<footer>PHQ-4 items shown verbatim for screening integrity. © Cosmic Compass</footer>-->
  </div>

<script>
  // ===== CONFIG =====
  const PHQ_OPTIONS = [
    { label: "Not at all", score: 0 },
    { label: "Several days", score: 1 },
    { label: "More than half the days", score: 2 },
    { label: "Nearly every day", score: 3 },
  ];

  const PHQ_ITEMS = [
    { id: "phq1", type: "phq", text: "Over the last 2 weeks, how often have you been bothered by feeling nervous, anxious, or on edge?" },
    { id: "phq2", type: "phq", text: "Over the last 2 weeks, how often have you been bothered by not being able to stop or control worrying?" },
    { id: "phq3", type: "phq", text: "Over the last 2 weeks, how often have you been bothered by little interest or pleasure in doing things?" },
    { id: "phq4", type: "phq", text: "Over the last 2 weeks, how often have you been bothered by feeling down, depressed, or hopeless?" },
  ];

  const PLANET_QUESTIONS = [
    { id:"pq1", type:"planet", text:"You’re about to launch your rocket. What’s going through your head?",
      options:[
        {label:"Let’s goooo, can’t wait to blast off!", tag:"fire"},
        {label:"I’m calculating every possible failure point", tag:"ice"},
        {label:"I hope the crew’s ready and safe", tag:"water"},
        {label:"Wow, space is so big, this is surreal", tag:"air"},
      ]},
    { id:"pq2", type:"planet", text:"As your ship drifts into an asteroid field, how do you react?",
      options:[
        {label:"Treat it like an obstacle course", tag:"air"},
        {label:"Stress over every possible crash", tag:"ice"},
        {label:"Trust my instincts and fly through", tag:"fire"},
        {label:"Call mission control for reassurance", tag:"water"},
      ]},
    { id:"pq3", type:"planet", text:"A new alien festival invites you to join. What’s your vibe?",
      options:[
        {label:"Jump in and dance with everyone", tag:"fire"},
        {label:"Observe quietly, not sure if I want to join", tag:"ice"},
        {label:"Go with friends, it’s better together", tag:"water"},
        {label:"Wander around, curious about everything", tag:"air"},
      ]},
    { id:"pq4", type:"planet", text:"You’re floating alone in deep space, stars all around. What’s your thought?",
      options:[
        {label:"I feel so small… kinda heavy", tag:"ice"},
        {label:"It’s peaceful, I could stay here forever", tag:"water"},
        {label:"I should set a new course, adventure awaits!", tag:"fire"},
        {label:"I wonder what’s beyond those galaxies", tag:"air"},
      ]},
    { id:"pq5", type:"planet", text:"If your personality was a type of star, you’d be…",
      options:[
        {label:"A distant cold white dwarf", tag:"ice"},
        {label:"A blazing supernova", tag:"fire"},
        {label:"A mysterious pulsar", tag:"air"},
        {label:"A gentle, steady sun", tag:"water"},
      ]},
    { id:"pq6", type:"planet", text:"When you look at the night sky, what grabs your attention most?",
      options:[
        {label:"The quiet, dark patches", tag:"ice"},
        {label:"The brightest stars", tag:"fire"},
        {label:"The shooting stars", tag:"air"},
        {label:"The constellations and patterns", tag:"water"},
      ]},
    { id:"pq7", type:"planet", text:"Imagine discovering a new planet. What would it be like?",
      options:[
        {label:"A volcanic, stormy world", tag:"fire"},
        {label:"A frozen crystal landscape", tag:"ice"},
        {label:"A windy, cloud-drenched giant", tag:"air"},
        {label:"A lush, ocean-covered paradise", tag:"water"},
      ]},
    { id:"pq8", type:"planet", text:"The universe grants you a spaceship name — what’s it called?",
      options:[
        {label:"Blaze Voyager", tag:"fire"},
        {label:"Silent Horizon", tag:"ice"},
        {label:"Star Chaser", tag:"air"},
        {label:"Ocean Dreamer", tag:"water"},
      ]},
  ];

  const EXTRA_ITEMS = [
    { id: "yob", type: "input_year", text: "What's your year of launch (birth year)?", placeholder: "e.g., 2008" },
    { id: "nat", type: "select_nat", text: "Almost ready for takeoff! Where are you blasting off from?", options: [
      { label: "Home Base (Singapore Citizen)", value: "sg" },
      { label: "Lunar Outpost (Singapore PR)", value: "spr" },
      { label: "A Galaxy Far, Far Away (Non-Singapore Citizen)", value: "non-sg" },
    ]},
  ];

  const SEQUENCE = ["pq1","pq2","phq1","pq3","phq2","pq4","pq5","phq3","pq6","phq4","pq7","pq8","yob","nat"];

  const PLANET_MATRIX = {
    fire:{ normal:{id:"mars",    name:"Mars"},    mild:{id:"mercury", name:"Mercury"}, elevated:{id:"venus",   name:"Venus"} },
    ice: { normal:{id:"saturn",  name:"Saturn"},  mild:{id:"uranus",  name:"Uranus"},  elevated:{id:"pluto",  name:"Pluto"} },
    water:{ normal:{id:"earth",   name:"Earth"},   mild:{id:"venus",   name:"Venus"},   elevated:{id:"neptune", name:"Neptune"} },
    air: { normal:{id:"jupiter", name:"Jupiter"}, mild:{id:"uranus",  name:"Uranus"},  elevated:{id:"neptune",name:"Neptune"} },
  };

  function bandFromPHQ(total){ if(total<=2) return "normal"; if(total<=5) return "mild"; return "elevated"; }

  // ===== BOOT =====
  const allItems = [...PHQ_ITEMS, ...PLANET_QUESTIONS, ...EXTRA_ITEMS];
  const ITEM_LOOKUP = Object.fromEntries(allItems.map(q => [q.id, q]));
  const questions = SEQUENCE.map(id => {
    const it = ITEM_LOOKUP[id];
    if(!it) return null;
    if(it.type === 'planet') return { ...it, _options: shuffled(it.options) };
    if(it.type === 'phq')    return { ...it, _options: PHQ_OPTIONS };
    return { ...it };
  }).filter(Boolean);

  // ===== STATE/DOM =====
  let step = 0;
  const answers = {};
  const bar = document.getElementById('bar');
  const counter = document.getElementById('counter');
  const kicker = document.getElementById('kicker');
  const qtext = document.getElementById('qtext');
  const optsEl = document.getElementById('opts');
  const hint = document.getElementById('hint');
  const backBtn = document.getElementById('backBtn');
  const nextBtn = document.getElementById('nextBtn');
  const resultsCard = document.getElementById('results');
  const emailEl = document.getElementById('email');
  const phoneEl = document.getElementById('phone');
  const submitBtn = document.getElementById('submitBtn');
  const submitMsg = document.getElementById('submitMsg');
  const reveal = document.getElementById('reveal');
  const domFlavor = document.getElementById('domFlavor');
  const bandEl = document.getElementById('band');
  const planetTitle = document.getElementById('planetTitle');
  const planetBlurb = document.getElementById('planetBlurb');
  const phqTotalEl = document.getElementById('phqTotal');
  const shareBtn = document.getElementById('shareBtn');
  const eligCta = document.getElementById('eligCta');

  // Lead capture wiring (button-enabled reveal)
  emailEl.addEventListener('input', updateSubmitState);
  phoneEl.addEventListener('input', updateSubmitState);
  submitBtn.addEventListener('click', submitLeadAndReveal);

  // Share button
  shareBtn.addEventListener('click', ()=>{
    const title = 'My Cosmic Planet';
    const text = planetTitle.textContent ? `I’m ${planetTitle.textContent} — what’s your planet?` : 'My Cosmic Planet result';
    const url = location.href;
    if(navigator.share){ navigator.share({title,text,url}); } else { alert(text + '\n' + url); }
  });

  // ===== RENDER =====
  function render(){
    const total = questions.length;
    const pct = Math.min(100, ((step+1)/total)*100);
    bar.style.width = pct + '%';
    counter.textContent = (step+1) + ' / ' + total;

    const q = questions[step];
    kicker.textContent = q.type==='phq' ? '' : '';
    qtext.textContent = q.text;

    optsEl.innerHTML = '';
    hint.style.display = 'none';

    if(q.type==='planet' || q.type==='phq'){
      (q._options||[]).forEach(opt=>{
        const b = document.createElement('button');
        b.className='btn';
        b.textContent = opt.label;
        if(isSelected(q.id,opt)) b.classList.add('selected');
        b.addEventListener('click',()=>{ select(q,opt); render(); });
        optsEl.appendChild(b);
      });
    } else if(q.type==='input_year'){
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = q.placeholder || 'e.g., 2008';
      input.min = '1900';
      input.max = String(new Date().getFullYear());
      input.value = answers[q.id]?.year || '';
      input.addEventListener('input',()=>{ answers[q.id] = { year: input.value.trim() }; });
      optsEl.appendChild(input);
    } else if(q.type==='select_nat'){
      const sel = document.createElement('select');
      const ph = document.createElement('option'); ph.value=''; ph.textContent='Select an option';
      sel.appendChild(ph);
      (q.options||[]).forEach(o=>{ const opt=document.createElement('option'); opt.value=o.value; opt.textContent=o.label; sel.appendChild(opt); });
      if(answers[q.id]?.nat){ sel.value = answers[q.id].nat; }
      sel.addEventListener('change',()=>{ answers[q.id] = { nat: sel.value }; });
      optsEl.appendChild(sel);
    }

    backBtn.disabled = (step===0);
    nextBtn.textContent = (step<total-1)?'Next':'Finish';
  }

  function isSelected(qid,opt){
    const a = answers[qid]; if(!a) return false;
    return (a.score!==undefined && a.score===opt.score) || (a.tag!==undefined && a.tag===opt.tag);
  }
  function select(q,opt){ answers[q.id] = (q.type==='phq') ? { score: opt.score } : { tag: opt.tag }; }

  backBtn.addEventListener('click',()=>{ if(step===0) return; step--; render(); });
  nextBtn.addEventListener('click',()=>{
    const q = questions[step];
    if(!isAnswered(q)){ hint.style.display='block'; return; }
    if(step < questions.length-1){ step++; render(); }
    else { finish(); }
  });

  function isAnswered(q){
    if(q.type==='planet' || q.type==='phq') return !!answers[q.id];
    if(q.type==='input_year'){
      const y = parseInt((answers[q.id]?.year||'').trim(),10);
      const now = new Date().getFullYear();
      return Number.isInteger(y) && y>=1900 && y<=now;
    }
    if(q.type==='select_nat'){
      const v = answers[q.id]?.nat || '';
      return v==='sg' || v==='spr' || v==='non-sg';
    }
    return true;
  }

  // ===== FINISH =====
  function finish(){
    const phqTotal = (answers.phq1?.score||0)+(answers.phq2?.score||0)+(answers.phq3?.score||0)+(answers.phq4?.score||0);
    const flavorCounts = { fire:0, ice:0, water:0, air:0 };
    Object.entries(answers).forEach(([id,val])=>{ if(id.startsWith('pq') && val?.tag) flavorCounts[val.tag]++; });
    const dom = Object.entries(flavorCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'fire';
    const band = bandFromPHQ(phqTotal);
    const planet = PLANET_MATRIX[dom][band];

    // Eligibility routing
    const yob = parseInt((answers.yob?.year||'').trim(),10);
    const now = new Date().getFullYear();
    const age = Number.isInteger(yob) ? (now - yob) : NaN;
    const nat = answers.nat?.nat || '';

    const isSGCitizen = nat === 'sg';
    const inYouthBand = Number.isFinite(age) && age >= 12 && age <= 25;
    const isAbove25 = Number.isFinite(age) && age > 25;

    let route = { label: '', url: '' };
    if(isSGCitizen && inYouthBand){
      route = { label: 'Proceed to SAMH Telegram bot', url: 'https://t.me/CommanderSam_bot' };
    } else if(isSGCitizen && isAbove25){
      route = { label: 'Proceed to COMIT', url: 'https://supportgowhere.life.gov.sg/services/SVC-CITC/community-intervention-team-comit' };
    } else {
      route = { label: 'Proceed to Limitless', url: 'https://www.limitless.sg/' };
    }

    // Show results card (but keep reveal hidden until submit)
    resultsCard.style.display = 'block';
    domFlavor.textContent = capitalize(dom);
    bandEl.textContent = bandLabel(band);
    planetTitle.textContent = planet.name;
    planetBlurb.textContent = '';
    phqTotalEl.textContent = phqTotal;

    eligCta.textContent = route.label;
    eligCta.href = route.url;

    // Reset gating UI
    reveal.style.display = 'none';
    submitMsg.style.display = 'none';
    submitBtn.textContent = 'Submit & Reveal!';
    updateSubmitState();

    resultsCard.scrollIntoView({behavior:'smooth'});
  }

  // ===== SUBMIT-&-REVEAL FLOW =====
  const LEAD_ENDPOINT = ""; // put your webhook here. If empty → simulate success

  function isValidEmail(s){ s=(s||'').trim(); const at=s.indexOf('@'), dot=s.lastIndexOf('.'); return at>0 && dot>at+1 && dot<s.length-1; }
  function isValidPhone(s){ const d=(s||'').replace(/\D/g,''); return d.length>=8; }

      function updateSubmitState(){
        const okContact = isValidEmail(emailEl.value) || isValidPhone(phoneEl.value);
        submitBtn.disabled = !okContact;
      }

  async function submitLeadAndReveal(){
    submitMsg.style.display = 'none';
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting…';
    const payload = buildPayload();

    try{
      if(LEAD_ENDPOINT){
        const res = await fetch(LEAD_ENDPOINT, {
          method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload), mode:'cors', credentials:'omit'
        });
        if(!res.ok) throw new Error('HTTP '+res.status);
      } else {
        // Simulate success if no endpoint configured
        await new Promise(r=>setTimeout(r,500));
      }
      // Success → reveal
      reveal.style.display = 'block';
      submitBtn.textContent = 'Submitted ✓';
    } catch(err){
      submitMsg.textContent = 'Could not save your contact. Please try again.';
      submitMsg.style.display = 'block';
      submitBtn.textContent = 'Submit & reveal';
      updateSubmitState();
    }
  }

  function buildPayload(){
    const phqTotal = (answers.phq1?.score||0)+(answers.phq2?.score||0)+(answers.phq3?.score||0)+(answers.phq4?.score||0);
    const flavorCounts = { fire:0, ice:0, water:0, air:0 };
    Object.entries(answers).forEach(([id,val])=>{ if(id.startsWith('pq') && val?.tag) flavorCounts[val.tag]++; });
    const dom = Object.entries(flavorCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'fire';
    const band = bandFromPHQ(phqTotal);
    const planet = PLANET_MATRIX[dom][band];

    const yob = parseInt((answers.yob?.year||'').trim(),10);
    const age = Number.isInteger(yob) ? (new Date().getFullYear() - yob) : null;
    const nat = answers.nat?.nat || '';

    let referral = 'limitless';
    if(nat === 'sg' && age != null){
      if(age >= 12 && age <= 25) referral = 'samh';
      else if(age > 25) referral = 'comit';
    }

    return {
      contact: {
        email: (emailEl.value||'').trim(),
        phone: (phoneEl.value||'').trim(),
      },
      quiz: {
        answers,
        phqTotal,
        phqBand: band,
        dominantFlavor: dom,
        planetId: planet.id,
        planetName: planet.name,
        age,
        nationality: nat,
        referral
      },
      meta: {
        ts: new Date().toISOString(),
        ua: navigator.userAgent
      }
    };
  }

  // ===== HELPERS =====
  function capitalize(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : s; }
  function bandLabel(b){ return b==='normal'?'Normal (0–2)': b==='mild'?'Mild (3–5)':'Elevated (6–12)'; }
  function shuffled(arr){ return arr.map(v=>({v, r:Math.random()})).sort((a,b)=>a.r-b.r).map(o=>o.v); }

  // init
  render();
</script>
</body>
</html>
